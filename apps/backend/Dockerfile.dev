# =================================================================
# NestJS Backend - Development Dockerfile
# í”„ë¡œì íŠ¸: ê´‘ë‚¨ë™ì„±ë‹¹ ì²­ì†Œë…„ìœ„ì›íšŒ ì˜ˆê²°ì‚° ê´€ë¦¬ ì‹œìŠ¤í…œ
# í™˜ê²½: Development
# =================================================================

FROM node:18-alpine

# ë©”íƒ€ë°ì´í„° ì„¤ì •
LABEL maintainer="ê´‘ë‚¨ë™ì„±ë‹¹ ì²­ì†Œë…„ìœ„ì›íšŒ ê°œë°œíŒ€"
LABEL description="NestJS Backend Development Container"
LABEL version="1.0.0"

# ê°œë°œ ë„êµ¬ ì„¤ì¹˜ (Alpine Linux)
RUN apk add --no-cache \
    curl \
    git \
    bash \
    vim \
    postgresql-client \
    python3 \
    make \
    g++ \
    && rm -rf /var/cache/apk/*

# ì‘ì—… ë””ë ‰í„°ë¦¬ ì„¤ì •
WORKDIR /app

# ì‚¬ìš©ì ë° ê·¸ë£¹ ìƒì„± (ë³´ì•ˆ)
RUN addgroup -g 1001 -S nodejs \
    && adduser -S nestjs -u 1001 -G nodejs

# ì˜ì¡´ì„± ìºì‹±ì„ ìœ„í•œ package íŒŒì¼ë“¤ë§Œ ë¨¼ì € ë³µì‚¬
COPY package*.json ./
COPY tsconfig*.json ./
COPY nest-cli.json ./

# Node.js ì˜ì¡´ì„± ì„¤ì¹˜
RUN npm install \
    && npm cache clean --force

# ê¸€ë¡œë²Œ ë„êµ¬ ì„¤ì¹˜
RUN npm install -g @nestjs/cli nodemon

# ì• í”Œë¦¬ì¼€ì´ì…˜ ì½”ë“œ ë³µì‚¬
COPY . .

# bcrypt ë„¤ì´í‹°ë¸Œ ëª¨ë“ˆ ì¬ë¹Œë“œ (í”Œë«í¼ í˜¸í™˜ì„±)
RUN npm rebuild bcrypt --build-from-source

# ë””ë ‰í„°ë¦¬ ê¶Œí•œ ì„¤ì •
RUN mkdir -p /app/uploads /app/logs \
    && chown -R nestjs:nodejs /app \
    && chmod -R 755 /app

# ì‚¬ìš©ì ì „í™˜
USER nestjs

# í™˜ê²½ ë³€ìˆ˜ ì„¤ì •
ENV NODE_ENV=development
ENV NODE_OPTIONS="--max-old-space-size=4096"
ENV NPM_CONFIG_LOGLEVEL=warn

# í¬íŠ¸ ì„¤ì •
EXPOSE 8000

# í—¬ìŠ¤ì²´í¬ ì„¤ì •
HEALTHCHECK --interval=30s --timeout=10s --start-period=60s --retries=3 \
    CMD curl -f http://localhost:8000/api/health || exit 1

# ê°œë°œìš© ì‹œì‘ ëª…ë ¹ì–´ (Hot Reload)
CMD ["npm", "run", "start:dev"]

# =================================================================
# ê°œë°œ ìµœì í™” ì„¤ì •
# =================================================================
# 
# ğŸ”§ ê°œë°œ í¸ì˜ ê¸°ëŠ¥:
#   - Hot Reload: ì½”ë“œ ë³€ê²½ ì‹œ ìë™ ì¬ì‹œì‘
#   - ë””ë²„ê¹…: ê°œë°œìš© ë¡œê¹… ë° ì—ëŸ¬ ìƒì„¸ ì¶œë ¥
#   - ì˜ì¡´ì„± ìºì‹±: ë¹ ë¥¸ ë¹Œë“œë¥¼ ìœ„í•œ ë ˆì´ì–´ ìºì‹±
#   - PostgreSQL í´ë¼ì´ì–¸íŠ¸: ë°ì´í„°ë² ì´ìŠ¤ ë””ë²„ê¹… ë„êµ¬
#
# ğŸ›¡ï¸ ë³´ì•ˆ ì„¤ì •:
#   - Non-root ì‚¬ìš©ì: nestjs ê³„ì •ìœ¼ë¡œ ì‹¤í–‰
#   - ìµœì†Œ ê¶Œí•œ: í•„ìš”í•œ ê¶Œí•œë§Œ ë¶€ì—¬
#   - Alpine Linux: ê²½ëŸ‰í™” ë° ë³´ì•ˆ ê°•í™”
#
# ğŸš€ ì„±ëŠ¥ ìµœì í™”:
#   - ì˜ì¡´ì„± ë ˆì´ì–´ ë¶„ë¦¬: package.json ë³€ê²½ì‹œì—ë§Œ ì¬ì„¤ì¹˜
#   - ë©”ëª¨ë¦¬ ì„¤ì •: ê°œë°œìš© ì¶©ë¶„í•œ ë©”ëª¨ë¦¬ í• ë‹¹
#   - npm ìºì‹œ ì •ë¦¬: ì´ë¯¸ì§€ í¬ê¸° ìµœì í™”
# =================================================================