# =================================================================
# OCR Service - Development Dockerfile
# í”„ë¡œì íŠ¸: ê´‘ë‚¨ë™ì„±ë‹¹ ì²­ì†Œë…„ìœ„ì›íšŒ ì˜ˆê²°ì‚° ê´€ë¦¬ ì‹œìŠ¤í…œ
# í™˜ê²½: Development
# =================================================================

FROM python:3.11-slim

# ë©”íƒ€ë°ì´í„° ì„¤ì •
LABEL maintainer="ê´‘ë‚¨ë™ì„±ë‹¹ ì²­ì†Œë…„ìœ„ì›íšŒ ê°œë°œíŒ€"
LABEL description="OCR Service Development Container"
LABEL version="1.0.0"

# í™˜ê²½ ë³€ìˆ˜ ì„¤ì •
ENV PYTHONUNBUFFERED=1
ENV PYTHONDONTWRITEBYTECODE=1
ENV DEBIAN_FRONTEND=noninteractive

# ì‹œìŠ¤í…œ íŒ¨í‚¤ì§€ ì„¤ì¹˜ (Tesseract OCR + í•œêµ­ì–´ ì–¸ì–´íŒ© + ë¹Œë“œ ë„êµ¬)
RUN apt-get update && apt-get install -y \
    tesseract-ocr \
    tesseract-ocr-kor \
    tesseract-ocr-eng \
    libtesseract-dev \
    libgl1-mesa-dev \
    libglib2.0-0 \
    libsm6 \
    libxext6 \
    libxrender-dev \
    libgomp1 \
    libgthread-2.0-0 \
    ffmpeg \
    gcc \
    g++ \
    python3-dev \
    build-essential \
    curl \
    git \
    vim \
    && apt-get clean \
    && rm -rf /var/lib/apt/lists/*

# ì‘ì—… ë””ë ‰í„°ë¦¬ ì„¤ì •
WORKDIR /app

# ì‚¬ìš©ì ë° ê·¸ë£¹ ìƒì„± (ë³´ì•ˆ)
RUN addgroup --gid 1001 --system python \
    && adduser --uid 1001 --system --group python

# Python ì˜ì¡´ì„± ì„¤ì¹˜
COPY requirements.txt .

RUN pip install --no-cache-dir --upgrade pip \
    && pip install --no-cache-dir -r requirements.txt

# Tesseract ì„¤ì • í™•ì¸
RUN tesseract --version \
    && tesseract --list-langs

# ì• í”Œë¦¬ì¼€ì´ì…˜ ì½”ë“œ ë³µì‚¬
COPY . .

# í•„ìš”í•œ ë””ë ‰í„°ë¦¬ ìƒì„± ë° ê¶Œí•œ ì„¤ì •
RUN mkdir -p /app/uploads /app/logs /app/temp \
    && chown -R python:python /app \
    && chmod -R 755 /app

# ì‚¬ìš©ì ì „í™˜
USER python

# í¬íŠ¸ ì„¤ì •
EXPOSE 8001

# í—¬ìŠ¤ì²´í¬ ì„¤ì •
HEALTHCHECK --interval=30s --timeout=10s --start-period=60s --retries=3 \
    CMD curl -f http://localhost:8001/health || exit 1

# ê°œë°œìš© ì‹œì‘ ëª…ë ¹ì–´ (Hot Reload)
CMD ["uvicorn", "app.main:app", "--host", "0.0.0.0", "--port", "8001", "--reload", "--reload-dir", "/app"]

# =================================================================
# ê°œë°œ ìµœì í™” ì„¤ì •
# =================================================================
# 
# ğŸ”§ ê°œë°œ í¸ì˜ ê¸°ëŠ¥:
#   - Hot Reload: ì½”ë“œ ë³€ê²½ ì‹œ ìë™ ì¬ì‹œì‘
#   - ë””ë²„ê¹…: ê°œë°œìš© ë¡œê¹… ë° ì—ëŸ¬ ìƒì„¸ ì¶œë ¥
#   - Tesseract: í•œêµ­ì–´+ì˜ì–´ OCR ì—”ì§„
#   - OpenCV: ì´ë¯¸ì§€ ì „ì²˜ë¦¬ ë¼ì´ë¸ŒëŸ¬ë¦¬
#
# ğŸ›¡ï¸ ë³´ì•ˆ ì„¤ì •:
#   - Non-root ì‚¬ìš©ì: python ê³„ì •ìœ¼ë¡œ ì‹¤í–‰
#   - ìµœì†Œ ê¶Œí•œ: í•„ìš”í•œ ê¶Œí•œë§Œ ë¶€ì—¬
#   - Debian Slim: ê²½ëŸ‰í™” ë° ë³´ì•ˆ ê°•í™”
#
# ğŸš€ ì„±ëŠ¥ ìµœì í™”:
#   - ì˜ì¡´ì„± ìºì‹±: requirements.txt ë³€ê²½ì‹œì—ë§Œ ì¬ì„¤ì¹˜
#   - ì‹œìŠ¤í…œ íŒ¨í‚¤ì§€ ì •ë¦¬: apt ìºì‹œ ì œê±°
#   - Python ìµœì í™”: ë°”ì´íŠ¸ì½”ë“œ ìºì‹± ë¹„í™œì„±í™”
#   - OCR ì—”ì§„: Tesseract ìµœì‹  ë²„ì „ ì‚¬ìš©
# =================================================================