# 비즈니스 규칙 정의 - 광남동성당 청소년위원회 예결산 관리 시스템

## 개요

본 문서는 시스템 운영에 필요한 핵심 비즈니스 규칙들을 정의합니다. 이 규칙들은 데이터베이스 제약조건, 애플리케이션 로직, 사용자 권한 등에 반영되어야 합니다.

## 1. 사용자 및 권한 관리 규칙

### 1.1 사용자 계정 관리
- **BR-001**: 이메일은 시스템 내에서 고유해야 하며, 유효한 이메일 형식이어야 함
- **BR-002**: 비밀번호는 최소 8자 이상, 영문 대소문자, 숫자, 특수문자 중 3가지 이상 포함
- **BR-003**: 전화번호는 숫자와 하이픈(-) 만 허용하며, 10-15자리여야 함
- **BR-004**: 사용자 계정은 생성 시 기본적으로 활성 상태(is_active = true)
- **BR-005**: 비활성 계정은 로그인 및 시스템 접근 불가
- **BR-006**: 관리자 계정은 모든 단체 및 행사에 접근 가능

### 1.2 단체-사용자 관계
- **BR-007**: 한 사용자는 여러 단체에 속할 수 있으나, 동일한 사용자-단체 조합은 한 번만 허용
- **BR-008**: 단체 내 ADMIN 역할은 해당 단체의 모든 행사를 관리할 수 있음
- **BR-009**: MEMBER 역할은 자신이 생성한 행사만 수정/삭제 가능
- **BR-010**: 비활성 단체(is_active = false)에는 새로운 행사 생성 불가
- **BR-011**: 단체에서 탈퇴(is_active = false)한 사용자는 해당 단체의 행사 접근 불가

## 2. 행사 관리 규칙

### 2.1 행사 생성 및 수정
- **BR-020**: 행사는 해당 단체의 회원만 생성 가능
- **BR-021**: 행사명은 최소 2자 이상이어야 함
- **BR-022**: 시작일은 종료일보다 빠르거나 같아야 함
- **BR-023**: 배정 예산은 0 이상의 값이어야 함 (null 허용)
- **BR-024**: 행사 수정은 생성자 또는 해당 단체의 ADMIN, 시스템 관리자만 가능
- **BR-025**: 행사 삭제는 생성자 또는 해당 단체의 ADMIN, 시스템 관리자만 가능

### 2.2 행사 상태 관리
- **BR-026**: 행사 상태는 PLANNING → IN_PROGRESS → COMPLETED 순서로만 변경 가능
- **BR-027**: CANCELLED 상태로는 언제든 변경 가능하나, 되돌릴 수 없음
- **BR-028**: COMPLETED 또는 CANCELLED 상태의 행사는 수정 불가
- **BR-029**: IN_PROGRESS 상태에서만 실제 지출 입력 가능

## 3. 예산 관리 규칙

### 3.1 예산서 작성
- **BR-040**: 하나의 행사당 하나의 예산서만 작성 가능
- **BR-041**: 예산서 작성은 해당 행사에 접근 권한이 있는 사용자만 가능
- **BR-042**: 총 수입과 총 지출은 각각 0 이상이어야 함
- **BR-043**: 잔액은 총수입에서 총지출을 뺀 값으로 자동 계산
- **BR-044**: 예산 항목(수입/지출)의 금액은 반드시 양수여야 함

### 3.2 예산서 승인
- **BR-045**: 예산서 승인은 시스템 관리자 또는 해당 단체의 ADMIN만 가능
- **BR-046**: DRAFT 상태에서만 수정 가능
- **BR-047**: SUBMITTED 상태에서는 승인/반려만 가능
- **BR-048**: APPROVED 상태의 예산서는 수정 불가
- **BR-049**: REJECTED 상태에서는 DRAFT로 되돌려서 수정 후 재제출 가능

### 3.3 예산 항목 관리
- **BR-050**: 동일 예산서 내에서 수입/지출 항목의 표시 순서는 고유해야 함
- **BR-051**: 예산 항목 삭제 시 총액 자동 재계산
- **BR-052**: 예산 항목은 최소 1개 이상 존재해야 함 (수입 또는 지출 중 하나)

## 4. 결산 관리 규칙

### 4.1 결산서 작성
- **BR-060**: 하나의 행사당 하나의 결산서만 작성 가능
- **BR-061**: 결산서는 해당 행사가 IN_PROGRESS 또는 COMPLETED 상태일 때만 작성 가능
- **BR-062**: 결산서 작성/수정은 해당 행사에 접근 권한이 있는 사용자만 가능
- **BR-063**: 총 수입과 총 지출은 각각 0 이상이어야 함
- **BR-064**: 잔액은 총수입에서 총지출을 뺀 값으로 자동 계산

### 4.2 결산서 완료
- **BR-065**: 결산서 완료는 시스템 관리자 또는 해당 단체의 ADMIN만 가능
- **BR-066**: COMPLETED 상태의 결산서는 수정 불가
- **BR-067**: 결산서 완료 시 영수증 첨부 개수 자동 업데이트
- **BR-068**: 결산서 완료 후에는 추가 영수증 업로드 불가

### 4.3 결산 항목 관리
- **BR-070**: 결산 항목의 실제 금액은 영수증 기반으로 입력
- **BR-071**: 동일 결산서 내에서 수입/지출 항목의 표시 순서는 고유해야 함
- **BR-072**: 결산 항목과 연결된 영수증의 총액 일치성 검증 필요

## 5. OCR 및 영수증 관리 규칙

### 5.1 OCR 작업 관리
- **BR-080**: OCR 작업은 결산서당 여러 개 생성 가능 (배치 처리)
- **BR-081**: OCR 작업 생성은 해당 결산서에 접근 권한이 있는 사용자만 가능
- **BR-082**: 처리된 파일 수는 성공 파일 수와 실패 파일 수의 합과 같아야 함
- **BR-083**: 처리된 파일 수는 전체 파일 수를 초과할 수 없음
- **BR-084**: FAILED 상태의 OCR 작업은 재실행 가능

### 5.2 영수증 관리
- **BR-085**: 영수증 총 금액은 반드시 양수여야 함
- **BR-086**: 영수증 날짜는 해당 행사 기간 내여야 함 (권장사항)
- **BR-087**: OCR 정확도는 0.0에서 1.0 사이의 값
- **BR-088**: 사업자등록번호는 XXX-XX-XXXXX 형식이어야 함
- **BR-089**: 사용자 검증(verified_by_user)은 OCR 결과 확인 후에만 true로 설정

### 5.3 영수증 상품 관리
- **BR-090**: 영수증 상품의 수량과 소계는 반드시 양수여야 함
- **BR-091**: 할인 금액은 0 이상이어야 함
- **BR-092**: 동일 영수증 내에서 상품 항목의 표시 순서는 고유해야 함
- **BR-093**: 영수증 상품들의 소계 합은 영수증 총액과 일치해야 함 (검증 규칙)

## 6. 콘텐츠 관리 규칙

### 6.1 게시물 관리
- **BR-100**: 게시물 제목은 최소 2자 이상이어야 함
- **BR-101**: 게시물 내용은 최소 10자 이상이어야 함
- **BR-102**: 미발행(is_published = false) 게시물은 작성자와 관리자만 조회 가능
- **BR-103**: 발행된 게시물의 조회수는 자동 증가
- **BR-104**: 게시물 수정/삭제는 작성자 또는 시스템 관리자만 가능

## 7. 인증 및 보안 규칙

### 7.1 JWT 토큰 관리
- **BR-120**: 리프레시 토큰은 사용자당 최대 5개까지만 허용
- **BR-121**: 만료된 리프레시 토큰은 자동으로 정리 (배치 작업)
- **BR-122**: 폐기된 토큰은 재사용 불가
- **BR-123**: 토큰 만료 시간은 생성 시간보다 늦어야 함
- **BR-124**: 동일한 기기에서의 중복 로그인 시 이전 토큰 자동 폐기

### 7.2 접근 권한
- **BR-125**: 비로그인 사용자는 공개 게시물만 조회 가능
- **BR-126**: 로그인 사용자는 자신이 속한 단체의 행사만 조회 가능
- **BR-127**: 시스템 관리자는 모든 데이터에 접근 가능
- **BR-128**: 단체 ADMIN은 해당 단체의 모든 데이터에 접근 가능
- **BR-129**: 일반 사용자는 자신이 생성한 데이터만 수정/삭제 가능

## 8. 데이터 무결성 규칙

### 8.1 참조 무결성
- **BR-140**: 외래키 관계는 반드시 유효한 참조를 가져야 함
- **BR-141**: 사용자 삭제 시 관련된 리프레시 토큰도 함께 삭제 (CASCADE)
- **BR-142**: 단체 삭제 시 관련된 사용자-단체 관계도 함께 삭제 (CASCADE)
- **BR-143**: 행사 삭제 시 관련된 예산서/결산서도 함께 삭제 (CASCADE)
- **BR-144**: 중요 데이터(사용자, 단체, 행사) 삭제 시에는 RESTRICT 정책 적용

### 8.2 데이터 일관성
- **BR-145**: 예산서/결산서의 총액은 하위 항목들의 합계와 일치해야 함
- **BR-146**: OCR 작업의 파일 카운트는 논리적으로 일치해야 함
- **BR-147**: 영수증 상품들의 소계 합은 영수증 총액과 일치해야 함
- **BR-148**: 결산서의 영수증 개수는 실제 첨부된 영수증 수와 일치해야 함

## 9. 성능 및 확장성 규칙

### 9.1 데이터 보존
- **BR-160**: 삭제된 데이터는 30일간 복구 가능하도록 소프트 삭제 적용
- **BR-161**: 로그 데이터는 1년간 보존 후 아카이브
- **BR-162**: 이미지 파일은 원본과 썸네일 버전으로 분리 저장
- **BR-163**: 대용량 파일 업로드 시 청크 단위로 분할 처리

### 9.2 성능 최적화
- **BR-164**: 자주 조회되는 데이터에 대해서는 적절한 인덱스 설정
- **BR-165**: 페이지네이션은 기본 20개, 최대 100개 항목으로 제한
- **BR-166**: 복잡한 쿼리의 응답 시간은 3초를 초과하지 않아야 함
- **BR-167**: 캐시 가능한 데이터는 Redis를 활용하여 성능 최적화

## 10. 예외 상황 처리 규칙

### 10.1 오류 처리
- **BR-180**: 모든 비즈니스 규칙 위반은 명확한 에러 메시지와 함께 차단
- **BR-181**: 시스템 오류 발생 시 사용자에게는 일반적인 메시지, 로그에는 상세 정보 기록
- **BR-182**: 트랜잭션 실패 시 모든 변경사항 롤백
- **BR-183**: 외부 서비스 연동 실패 시 재시도 로직 적용 (최대 3회)

### 10.2 복구 절차
- **BR-184**: 데이터 손상 발생 시 최근 백업으로 복구 후 차이점 수동 처리
- **BR-185**: 시스템 장애 시 읽기 전용 모드로 전환하여 조회 기능 유지
- **BR-186**: 백업은 매일 자동 수행되며, 주요 작업 전후에는 수동 백업 수행

---

**문서 버전**: 1.0  
**작성일**: 2025-01-08  
**작성자**: Backend Developer Team  
**검토자**: DevOps Engineer Team

## 참고 문서
- [데이터베이스 엔티티 분석](./entities.md)
- [TSD 02_Database_Schema](../TSD/02_Database_Schema.md)
- [TSD 04_Backend_Architecture](../TSD/04_Backend_Architecture.md)