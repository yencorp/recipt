# =================================================================
# Docker Compose - ê°œë°œí™˜ê²½ ì„¤ì •
# í”„ë¡œì íŠ¸: ê´‘ë‚¨ë™ì„±ë‹¹ ì²­ì†Œë…„ìœ„ì›íšŒ ì˜ˆê²°ì‚° ê´€ë¦¬ ì‹œìŠ¤í…œ
# í™˜ê²½: Development
# =================================================================

version: '3.8'

services:
  # =================================================================
  # Database Service - PostgreSQL 15
  # =================================================================
  database:
    container_name: recipt-database-dev
    image: postgres:15-alpine
    restart: unless-stopped
    
    environment:
      POSTGRES_DB: recipt_db
      POSTGRES_USER: recipt
      POSTGRES_PASSWORD: recipt123
      POSTGRES_INITDB_ARGS: "--encoding=UTF-8 --locale=C"
      TZ: Asia/Seoul
    
    ports:
      - "5432:5432"
    
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./database/init:/docker-entrypoint-initdb.d:ro
      - ./database/backups:/backups
    
    networks:
      - recipt-network
    
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U recipt -d recipt_db"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    
    deploy:
      resources:
        limits:
          memory: 512M
          cpus: '0.5'
        reservations:
          memory: 256M
          cpus: '0.25'
    
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # =================================================================
  # Redis Cache Service
  # =================================================================
  redis:
    container_name: recipt-redis-dev
    image: redis:7-alpine
    restart: unless-stopped
    
    command: redis-server --appendonly yes --requirepass redis123
    
    environment:
      TZ: Asia/Seoul
    
    ports:
      - "6379:6379"
    
    volumes:
      - redis_data:/data
      - ./docker/redis/redis.conf:/etc/redis/redis.conf:ro
    
    networks:
      - recipt-network
    
    healthcheck:
      test: ["CMD", "redis-cli", "--raw", "incr", "ping"]
      interval: 10s
      timeout: 3s
      retries: 5
      start_period: 20s
    
    deploy:
      resources:
        limits:
          memory: 256M
          cpus: '0.25'
        reservations:
          memory: 128M
          cpus: '0.1'
    
    logging:
      driver: "json-file"
      options:
        max-size: "5m"
        max-file: "3"

  # =================================================================
  # Backend Service - NestJS API
  # =================================================================
  backend:
    container_name: recipt-backend-dev
    build:
      context: ./apps/backend
      dockerfile: Dockerfile.dev
    restart: unless-stopped

    env_file:
      - ./apps/backend/.env.development

    environment:
      # Database Configuration
      DATABASE_URL: postgresql://recipt:recipt123@database:5432/recipt_db
      DATABASE_HOST: database
      DATABASE_PORT: 5432
      DATABASE_NAME: recipt_db
      DATABASE_USER: recipt
      DATABASE_PASSWORD: recipt123
      
      # Redis Configuration
      REDIS_HOST: redis
      REDIS_PORT: 6379
      REDIS_PASSWORD: redis123
      
      # Application Configuration
      NODE_ENV: development
      PORT: 8000
      API_PREFIX: api
      
      # JWT Configuration
      JWT_SECRET: dev-jwt-secret-key-change-in-production
      JWT_EXPIRES_IN: 7d

      # Bcrypt Configuration
      BCRYPT_SALT_ROUNDS: 10

      # OCR Service Configuration
      OCR_SERVICE_URL: http://ocr-service:8001
      
      # File Upload Configuration
      MAX_FILE_SIZE: 10485760  # 10MB
      UPLOAD_DIRECTORY: /app/uploads
      
      # Development Settings
      ENABLE_CORS: true
      LOG_LEVEL: debug
      ENABLE_SWAGGER: true
      
      # Timezone
      TZ: Asia/Seoul
    
    ports:
      - "8000:8000"
    
    volumes:
      - ./apps/backend:/app:delegated
      - /app/node_modules
      - backend_uploads:/app/uploads
      - ./logs/backend:/app/logs
    
    networks:
      - recipt-network
    
    depends_on:
      - database
      - redis
    
    deploy:
      resources:
        limits:
          memory: 1G
          cpus: '1.0'
        reservations:
          memory: 512M
          cpus: '0.5'
    
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "5"

  # =================================================================
  # Frontend Service - Next.js
  # =================================================================
  frontend:
    container_name: recipt-frontend-dev
    build:
      context: ./apps/frontend
      dockerfile: Dockerfile.dev
    restart: unless-stopped
    ports:
      - "3000:3000"
    env_file:
      - ./apps/frontend/.env.development
    volumes:
      - ./apps/frontend:/app
      - /app/node_modules
    depends_on:
      - backend
    networks:
      - recipt-network

    # React + VITE ê°œë°œ í™˜ê²½ ì„¤ì •
    environment:
      NODE_ENV: development
      VITE_API_URL: http://backend:8000/api
      VITE_OCR_URL: http://ocr-service:8001/api

      # Timezone
      TZ: Asia/Seoul
    
    deploy:
      resources:
        limits:
          memory: 512M
          cpus: '0.5'
        reservations:
          memory: 256M
          cpus: '0.25'
    
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # =================================================================
  # OCR Service - Python FastAPI
  # =================================================================
  ocr-service:
    container_name: recipt-ocr-dev
    build:
      context: ./apps/ocr-service
      dockerfile: Dockerfile.dev
    restart: unless-stopped
    
    environment:
      # Application Configuration
      PYTHONPATH: /app
      PYTHONUNBUFFERED: 1
      ENVIRONMENT: development
      
      # FastAPI Configuration
      HOST: 0.0.0.0
      PORT: 8001
      RELOAD: true
      LOG_LEVEL: debug
      
      # OCR Configuration
      TESSERACT_CMD: /usr/bin/tesseract
      TESSERACT_LANG: kor+eng
      OCR_CONFIDENCE_THRESHOLD: 60
      
      # File Processing Configuration
      UPLOAD_DIR: /app/uploads
      PROCESSED_DIR: /app/processed
      MAX_FILE_SIZE: 10485760
      _ALLOWED_EXTENSIONS_RAW: jpg,jpeg,png,pdf
      MAX_CONCURRENT_PROCESSES: 5
      
      # Database Configuration (for ML model storage)
      DATABASE_URL: postgresql://recipt:recipt123@database:5432/recipt_db
      
      # ML Model Configuration
      MODEL_PATH: /app/models
      ENABLE_MODEL_CACHE: true
      
      # Performance Settings
      WORKERS: 2
      WORKER_CONNECTIONS: 1000

      # Timezone
      TZ: Asia/Seoul

      # Fix HOME directory for EasyOCR
      HOME: /app
    
    ports:
      - "8001:8001"
    
    volumes:
      - ./apps/ocr-service:/app:delegated
      - ocr_uploads:/app/uploads
      - ocr_processed:/app/processed
      - ocr_models:/app/models
      - ./logs/ocr-service:/app/logs
    
    networks:
      - recipt-network
    
    depends_on:
      database:
        condition: service_healthy
    
    # healthcheck ë¹„í™œì„±í™” (ê°œë°œ í™˜ê²½ì—ì„œ ë¶ˆí•„ìš”)
    healthcheck:
      disable: true
    
    deploy:
      resources:
        limits:
          memory: 2G
          cpus: '1.5'
        reservations:
          memory: 1G
          cpus: '0.5'
    
    logging:
      driver: "json-file"
      options:
        max-size: "15m"
        max-file: "5"

# =================================================================
# Networks Configuration
# =================================================================
networks:
  recipt-network:
    driver: bridge
    name: recipt-dev-network
    ipam:
      config:
        - subnet: 172.20.0.0/16
          gateway: 172.20.0.1
    driver_opts:
      com.docker.network.bridge.name: recipt-dev-br0
      com.docker.network.driver.mtu: 1500

# =================================================================
# Volumes Configuration
# =================================================================
volumes:
  # Database Volumes
  postgres_data:
    driver: local
    name: recipt-postgres-dev-data
    driver_opts:
      type: none
      o: bind
      device: ${PWD}/docker/volumes/postgres

  redis_data:
    driver: local
    name: recipt-redis-dev-data
    driver_opts:
      type: none
      o: bind
      device: ${PWD}/docker/volumes/redis

  # Application Volumes
  backend_uploads:
    driver: local
    name: recipt-backend-dev-uploads
    driver_opts:
      type: none
      o: bind
      device: ${PWD}/docker/volumes/backend/uploads

  ocr_uploads:
    driver: local
    name: recipt-ocr-dev-uploads
    driver_opts:
      type: none
      o: bind
      device: ${PWD}/docker/volumes/ocr/uploads

  ocr_processed:
    driver: local
    name: recipt-ocr-dev-processed
    driver_opts:
      type: none
      o: bind
      device: ${PWD}/docker/volumes/ocr/processed

  ocr_models:
    driver: local
    name: recipt-ocr-dev-models
    driver_opts:
      type: none
      o: bind
      device: ${PWD}/docker/volumes/ocr/models

# =================================================================
# Development Environment Notes
# =================================================================
# 
# ğŸš€ ì‹œì‘í•˜ê¸°:
#   docker-compose -f docker-compose.dev.yml up -d
#
# ğŸ“Š ì„œë¹„ìŠ¤ ìƒíƒœ í™•ì¸:
#   docker-compose -f docker-compose.dev.yml ps
#
# ğŸ“‹ ë¡œê·¸ í™•ì¸:
#   docker-compose -f docker-compose.dev.yml logs -f [service-name]
#
# ğŸ”„ ì„œë¹„ìŠ¤ ì¬ì‹œì‘:
#   docker-compose -f docker-compose.dev.yml restart [service-name]
#
# ğŸ›‘ ì „ì²´ ì¤‘ì§€:
#   docker-compose -f docker-compose.dev.yml down
#
# ğŸ§¹ ë³¼ë¥¨ í¬í•¨ ì™„ì „ ì •ë¦¬:
#   docker-compose -f docker-compose.dev.yml down -v
#
# ğŸ“¡ ì ‘ì† ì •ë³´:
#   - Frontend: http://localhost:3000
#   - Backend API: http://localhost:8000
#   - Backend Docs: http://localhost:8000/api/docs
#   - OCR Service: http://localhost:8001
#   - PostgreSQL: localhost:5432 (recipt/recipt123)
#   - Redis: localhost:6379 (password: redis123)
#
# ğŸ”§ ê°œë°œ ì„¤ì •:
#   - ëª¨ë“  ì†ŒìŠ¤ ì½”ë“œëŠ” ì‹¤ì‹œê°„ ë™ê¸°í™”
#   - Hot reload í™œì„±í™”
#   - ê°œë°œìš© í™˜ê²½ ë³€ìˆ˜ ì ìš©
#   - ë””ë²„ê¹… ëª¨ë“œ í™œì„±í™”
# =================================================================