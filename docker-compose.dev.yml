# =================================================================
# Docker Compose - Í∞úÎ∞úÌôòÍ≤Ω ÏÑ§Ï†ï
# ÌîÑÎ°úÏ†ùÌä∏: Í¥ëÎÇ®ÎèôÏÑ±Îãπ Ï≤≠ÏÜåÎÖÑÏúÑÏõêÌöå ÏòàÍ≤∞ÏÇ∞ Í¥ÄÎ¶¨ ÏãúÏä§ÌÖú
# ÌôòÍ≤Ω: Development
# =================================================================

version: '3.8'

services:
  # =================================================================
  # Database Service - PostgreSQL 15
  # =================================================================
  database:
    container_name: recipt-database-dev
    image: postgres:15-alpine
    restart: unless-stopped
    
    environment:
      POSTGRES_DB: recipt_db
      POSTGRES_USER: recipt
      POSTGRES_PASSWORD: recipt123
      POSTGRES_INITDB_ARGS: "--encoding=UTF-8 --locale=C"
      TZ: Asia/Seoul
    
    ports:
      - "5432:5432"
    
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./database/init:/docker-entrypoint-initdb.d:ro
      - ./database/backups:/backups
    
    networks:
      - recipt-network
    
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U recipt -d recipt_db"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    
    deploy:
      resources:
        limits:
          memory: 512M
          cpus: '0.5'
        reservations:
          memory: 256M
          cpus: '0.25'
    
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # =================================================================
  # Redis Cache Service
  # =================================================================
  redis:
    container_name: recipt-redis-dev
    image: redis:7-alpine
    restart: unless-stopped
    
    command: redis-server --appendonly yes --requirepass redis123
    
    environment:
      TZ: Asia/Seoul
    
    ports:
      - "6379:6379"
    
    volumes:
      - redis_data:/data
      - ./docker/redis/redis.conf:/etc/redis/redis.conf:ro
    
    networks:
      - recipt-network
    
    healthcheck:
      test: ["CMD", "redis-cli", "--raw", "incr", "ping"]
      interval: 10s
      timeout: 3s
      retries: 5
      start_period: 20s
    
    deploy:
      resources:
        limits:
          memory: 256M
          cpus: '0.25'
        reservations:
          memory: 128M
          cpus: '0.1'
    
    logging:
      driver: "json-file"
      options:
        max-size: "5m"
        max-file: "3"

  # =================================================================
  # Backend Service - NestJS API
  # =================================================================
  backend:
    container_name: recipt-backend-dev
    build:
      context: ./apps/backend
      dockerfile: Dockerfile.dev
    restart: unless-stopped

    environment:
      # Application Configuration
      NODE_ENV: development
      PORT: 8000
      API_PREFIX: api

      # Database Configuration
      DATABASE_URL: postgresql://recipt:recipt123@database:5432/recipt_db
      DATABASE_HOST: database
      DATABASE_PORT: 5432
      DATABASE_NAME: recipt_db
      DATABASE_USER: recipt
      DATABASE_PASSWORD: recipt123
      DATABASE_SCHEMA: public

      # Redis Configuration
      REDIS_HOST: redis
      REDIS_PORT: 6379
      REDIS_PASSWORD: redis123
      REDIS_DB: 0
      REDIS_TTL: 3600

      # JWT Configuration
      JWT_SECRET: dev-jwt-secret-key-change-in-production-2024
      JWT_EXPIRES_IN: 7d
      JWT_REFRESH_EXPIRES_IN: 30d

      # Bcrypt Configuration
      BCRYPT_SALT_ROUNDS: 10

      # File Upload Configuration
      MAX_FILE_SIZE: 10485760
      UPLOAD_DIRECTORY: /app/uploads
      ALLOWED_FILE_TYPES: jpg,jpeg,png,pdf
      MAX_FILES_PER_UPLOAD: 10

      # OCR Service Configuration
      OCR_SERVICE_URL: http://ocr-service:8001
      OCR_SERVICE_TIMEOUT: 30000
      OCR_MAX_RETRIES: 3

      # CORS Configuration
      ENABLE_CORS: true
      CORS_ORIGIN: http://localhost:3000,http://localhost:3001
      CORS_CREDENTIALS: true

      # Rate Limiting
      THROTTLE_TTL: 60
      THROTTLE_LIMIT: 1000

      # Logging Configuration
      LOG_LEVEL: debug
      LOG_FILE_PATH: /app/logs
      ENABLE_REQUEST_LOGGING: true

      # Session Configuration
      SESSION_SECRET: dev-session-secret-change-in-production
      SESSION_NAME: recipt.sid
      SESSION_RESAVE: false
      SESSION_SAVE_UNINITIALIZED: false

      # Email Configuration
      SMTP_HOST: smtp.gmail.com
      SMTP_PORT: 465
      SMTP_SECURE: true
      SMTP_USER: jopark@yencorp.co.kr
      SMTP_PASSWORD: daqepfcfpapzggnw
      EMAIL_FROM: noreply@yencorp.co.kr
      FRONTEND_URL: http://localhost:3000
      ENABLE_EMAIL: true

      # External API Keys
      GOOGLE_VISION_API_KEY: ""
      NAVER_CLOVA_API_KEY: ""

      # Development Features
      ENABLE_SWAGGER: true
      SWAGGER_PATH: api/docs
      ENABLE_QUERY_LOGGING: true
      ENABLE_ERROR_STACK_TRACE: true

      # Health Check Configuration
      HEALTH_CHECK_ENABLED: true
      HEALTH_CHECK_DATABASE: true
      HEALTH_CHECK_REDIS: true
      HEALTH_CHECK_OCR_SERVICE: true

      # Performance Configuration
      MAX_JSON_SIZE: 10mb
      MAX_URL_ENCODED_SIZE: 10mb
      REQUEST_TIMEOUT: 30000

      # Security Configuration
      HELMET_ENABLED: true
      CSRF_ENABLED: false
      TRUST_PROXY: false

      # Timezone
      TZ: Asia/Seoul
    
    ports:
      - "8000:8000"
    
    volumes:
      - ./apps/backend:/app:delegated
      - /app/node_modules
      - backend_uploads:/app/uploads
      - ./logs/backend:/app/logs
    
    networks:
      - recipt-network
    
    depends_on:
      - database
      - redis
    
    deploy:
      resources:
        limits:
          memory: 1G
          cpus: '1.0'
        reservations:
          memory: 512M
          cpus: '0.5'
    
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "5"

  # =================================================================
  # Frontend Service - Next.js
  # =================================================================
  frontend:
    container_name: recipt-frontend-dev
    build:
      context: ./apps/frontend
      dockerfile: Dockerfile.dev
    restart: unless-stopped
    ports:
      - "3000:3000"
    volumes:
      - ./apps/frontend:/app
      - /app/node_modules
    depends_on:
      - backend
    networks:
      - recipt-network

    # React + VITE Í∞úÎ∞ú ÌôòÍ≤Ω ÏÑ§Ï†ï
    environment:
      NODE_ENV: development
      VITE_API_BASE_URL: http://localhost:8000/api
      VITE_APP_NAME: Í¥ëÎÇ®ÎèôÏÑ±Îãπ Ï≤≠ÏÜåÎÖÑÏúÑÏõêÌöå ÏòàÍ≤∞ÏÇ∞ Í¥ÄÎ¶¨

      # Timezone
      TZ: Asia/Seoul
    
    deploy:
      resources:
        limits:
          memory: 512M
          cpus: '0.5'
        reservations:
          memory: 256M
          cpus: '0.25'
    
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # =================================================================
  # OCR Service - Python FastAPI
  # =================================================================
  ocr-service:
    container_name: recipt-ocr-dev
    build:
      context: ./apps/ocr-service
      dockerfile: Dockerfile.dev
    restart: unless-stopped
    
    environment:
      # Application Configuration
      PYTHONPATH: /app
      PYTHONUNBUFFERED: 1
      ENVIRONMENT: development
      
      # FastAPI Configuration
      HOST: 0.0.0.0
      PORT: 8001
      RELOAD: true
      LOG_LEVEL: debug
      
      # OCR Configuration
      TESSERACT_CMD: /usr/bin/tesseract
      TESSERACT_LANG: kor+eng
      OCR_CONFIDENCE_THRESHOLD: 60
      
      # File Processing Configuration
      UPLOAD_DIR: /app/uploads
      PROCESSED_DIR: /app/processed
      MAX_FILE_SIZE: 10485760
      _ALLOWED_EXTENSIONS_RAW: jpg,jpeg,png,pdf
      MAX_CONCURRENT_PROCESSES: 5
      
      # Database Configuration (for ML model storage)
      DATABASE_URL: postgresql://recipt:recipt123@database:5432/recipt_db
      
      # ML Model Configuration
      MODEL_PATH: /app/models
      ENABLE_MODEL_CACHE: true
      
      # Performance Settings
      WORKERS: 2
      WORKER_CONNECTIONS: 1000

      # Timezone
      TZ: Asia/Seoul

      # Fix HOME directory for EasyOCR
      HOME: /app
    
    ports:
      - "8001:8001"
    
    volumes:
      - ./apps/ocr-service:/app:delegated
      - ocr_uploads:/app/uploads
      - ocr_processed:/app/processed
      - ocr_models:/app/models
      - ./logs/ocr-service:/app/logs
    
    networks:
      - recipt-network
    
    depends_on:
      database:
        condition: service_healthy
    
    # healthcheck ÎπÑÌôúÏÑ±Ìôî (Í∞úÎ∞ú ÌôòÍ≤ΩÏóêÏÑú Î∂àÌïÑÏöî)
    healthcheck:
      disable: true
    
    deploy:
      resources:
        limits:
          memory: 2G
          cpus: '1.5'
        reservations:
          memory: 1G
          cpus: '0.5'
    
    logging:
      driver: "json-file"
      options:
        max-size: "15m"
        max-file: "5"

# =================================================================
# Networks Configuration
# =================================================================
networks:
  recipt-network:
    driver: bridge
    name: recipt-dev-network
    ipam:
      config:
        - subnet: 172.20.0.0/16
          gateway: 172.20.0.1
    driver_opts:
      com.docker.network.bridge.name: recipt-dev-br0
      com.docker.network.driver.mtu: 1500

# =================================================================
# Volumes Configuration
# =================================================================
volumes:
  # Database Volumes
  postgres_data:
    driver: local
    name: recipt-postgres-dev-data
    driver_opts:
      type: none
      o: bind
      device: ${PWD}/docker/volumes/postgres

  redis_data:
    driver: local
    name: recipt-redis-dev-data
    driver_opts:
      type: none
      o: bind
      device: ${PWD}/docker/volumes/redis

  # Application Volumes
  backend_uploads:
    driver: local
    name: recipt-backend-dev-uploads
    driver_opts:
      type: none
      o: bind
      device: ${PWD}/docker/volumes/backend/uploads

  ocr_uploads:
    driver: local
    name: recipt-ocr-dev-uploads
    driver_opts:
      type: none
      o: bind
      device: ${PWD}/docker/volumes/ocr/uploads

  ocr_processed:
    driver: local
    name: recipt-ocr-dev-processed
    driver_opts:
      type: none
      o: bind
      device: ${PWD}/docker/volumes/ocr/processed

  ocr_models:
    driver: local
    name: recipt-ocr-dev-models
    driver_opts:
      type: none
      o: bind
      device: ${PWD}/docker/volumes/ocr/models

# =================================================================
# Development Environment Notes
# =================================================================
# 
# üöÄ ÏãúÏûëÌïòÍ∏∞:
#   docker-compose -f docker-compose.dev.yml up -d
#
# üìä ÏÑúÎπÑÏä§ ÏÉÅÌÉú ÌôïÏù∏:
#   docker-compose -f docker-compose.dev.yml ps
#
# üìã Î°úÍ∑∏ ÌôïÏù∏:
#   docker-compose -f docker-compose.dev.yml logs -f [service-name]
#
# üîÑ ÏÑúÎπÑÏä§ Ïû¨ÏãúÏûë:
#   docker-compose -f docker-compose.dev.yml restart [service-name]
#
# üõë Ï†ÑÏ≤¥ Ï§ëÏßÄ:
#   docker-compose -f docker-compose.dev.yml down
#
# üßπ Î≥ºÎ•® Ìè¨Ìï® ÏôÑÏ†Ñ Ï†ïÎ¶¨:
#   docker-compose -f docker-compose.dev.yml down -v
#
# üì° Ï†ëÏÜç Ï†ïÎ≥¥:
#   - Frontend: http://localhost:3000
#   - Backend API: http://localhost:8000
#   - Backend Docs: http://localhost:8000/api/docs
#   - OCR Service: http://localhost:8001
#   - PostgreSQL: localhost:5432 (recipt/recipt123)
#   - Redis: localhost:6379 (password: redis123)
#
# üîß Í∞úÎ∞ú ÏÑ§Ï†ï:
#   - Î™®Îì† ÏÜåÏä§ ÏΩîÎìúÎäî Ïã§ÏãúÍ∞Ñ ÎèôÍ∏∞Ìôî
#   - Hot reload ÌôúÏÑ±Ìôî
#   - Í∞úÎ∞úÏö© ÌôòÍ≤Ω Î≥ÄÏàò Ï†ÅÏö©
#   - ÎîîÎ≤ÑÍπÖ Î™®Îìú ÌôúÏÑ±Ìôî
# =================================================================