#!/usr/bin/env sh

# =================================================================
# Commit-msg Git Hook
# 프로젝트: 광남동성당 청소년위원회 예결산 관리 시스템
# 설명: Conventional Commits 표준 준수 검증
# =================================================================

. "$(dirname -- "$0")/_/husky.sh"

# 색상 정의
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# 커밋 메시지 파일 경로
COMMIT_MSG_FILE=$1
COMMIT_MSG=$(cat "$COMMIT_MSG_FILE")

echo -e "${BLUE}📝 커밋 메시지 검증 중...${NC}"
echo -e "${BLUE}메시지: ${COMMIT_MSG}${NC}"

# Conventional Commits 패턴 정의
# 형식: type(scope): description
# type은 필수, scope는 선택, description은 필수
CONVENTIONAL_PATTERN="^(feat|fix|docs|style|refactor|test|chore|perf|ci|build|revert)(\(.+\))?: .{1,72}"

# 허용되는 타입들
VALID_TYPES="feat|fix|docs|style|refactor|test|chore|perf|ci|build|revert"

# 특별한 커밋 메시지 패턴 (허용)
SPECIAL_PATTERNS=(
    "^Merge.*"
    "^Revert.*" 
    "^Initial commit"
    "^Update.*"
    "^Add.*"
    "^Remove.*"
    "^WIP.*"
    "^🤖 Generated with.*"
)

# 길이 제한
MAX_LENGTH=72
MIN_LENGTH=10

# ===== 길이 검증 =====
MSG_LENGTH=${#COMMIT_MSG}
if [ $MSG_LENGTH -lt $MIN_LENGTH ]; then
    echo -e "${RED}❌ 커밋 메시지가 너무 짧습니다 (최소 $MIN_LENGTH 자)${NC}"
    exit 1
fi

if [ $MSG_LENGTH -gt $MAX_LENGTH ]; then
    echo -e "${RED}❌ 커밋 메시지가 너무 깁니다 (최대 $MAX_LENGTH 자)${NC}"
    echo -e "${YELLOW}💡 현재 길이: $MSG_LENGTH 자${NC}"
    exit 1
fi

# ===== 특별한 패턴 확인 =====
for pattern in "${SPECIAL_PATTERNS[@]}"; do
    if echo "$COMMIT_MSG" | grep -qE "$pattern"; then
        echo -e "${GREEN}✅ 특별한 커밋 메시지 패턴으로 허용됩니다${NC}"
        exit 0
    fi
done

# ===== Conventional Commits 패턴 검증 =====
if ! echo "$COMMIT_MSG" | grep -qE "$CONVENTIONAL_PATTERN"; then
    echo -e "${RED}❌ Conventional Commits 표준을 준수하지 않습니다${NC}"
    echo -e "${YELLOW}📋 올바른 형식:${NC}"
    echo -e "${BLUE}  <type>(<scope>): <description>${NC}"
    echo -e "${BLUE}  또는${NC}"
    echo -e "${BLUE}  <type>: <description>${NC}"
    echo ""
    echo -e "${YELLOW}📝 허용되는 타입들:${NC}"
    echo -e "${GREEN}  • feat:     새로운 기능 추가${NC}"
    echo -e "${GREEN}  • fix:      버그 수정${NC}"
    echo -e "${GREEN}  • docs:     문서 수정${NC}"
    echo -e "${GREEN}  • style:    코드 스타일 변경 (포맷팅, 세미콜론 등)${NC}"
    echo -e "${GREEN}  • refactor: 코드 리팩토링${NC}"
    echo -e "${GREEN}  • test:     테스트 코드 추가 또는 수정${NC}"
    echo -e "${GREEN}  • chore:    빌드 프로세스 또는 도구 변경${NC}"
    echo -e "${GREEN}  • perf:     성능 개선${NC}"
    echo -e "${GREEN}  • ci:       CI 설정 변경${NC}"
    echo -e "${GREEN}  • build:    빌드 시스템 변경${NC}"
    echo -e "${GREEN}  • revert:   커밋 되돌리기${NC}"
    echo ""
    echo -e "${YELLOW}💡 예시:${NC}"
    echo -e "${BLUE}  feat: 사용자 인증 기능 추가${NC}"
    echo -e "${BLUE}  fix(auth): 로그인 오류 수정${NC}"
    echo -e "${BLUE}  docs: README 업데이트${NC}"
    echo -e "${BLUE}  refactor(api): 사용자 서비스 리팩토링${NC}"
    exit 1
fi

# ===== 타입 추출 및 검증 =====
TYPE=$(echo "$COMMIT_MSG" | sed -n 's/^\([a-z]*\).*/\1/p')
if ! echo "$TYPE" | grep -qE "^($VALID_TYPES)$"; then
    echo -e "${RED}❌ 올바르지 않은 커밋 타입: $TYPE${NC}"
    echo -e "${YELLOW}📝 허용되는 타입: $VALID_TYPES${NC}"
    exit 1
fi

# ===== 스코프 검증 (있는 경우) =====
if echo "$COMMIT_MSG" | grep -q "("; then
    SCOPE=$(echo "$COMMIT_MSG" | sed -n 's/^[a-z]*(\([^)]*\)).*/\1/p')
    if [ -z "$SCOPE" ]; then
        echo -e "${RED}❌ 빈 스코프는 허용되지 않습니다${NC}"
        echo -e "${YELLOW}💡 스코프를 사용하지 않거나 유효한 스코프를 입력하세요${NC}"
        exit 1
    fi
    
    # 스코프 길이 제한
    if [ ${#SCOPE} -gt 20 ]; then
        echo -e "${RED}❌ 스코프가 너무 깁니다 (최대 20자): $SCOPE${NC}"
        exit 1
    fi
    
    echo -e "${GREEN}✅ 스코프: $SCOPE${NC}"
fi

# ===== 설명 검증 =====
# 더 간단한 방법으로 설명 추출
DESCRIPTION=$(echo "$COMMIT_MSG" | sed 's/^[^:]*:[[:space:]]*//')
if [ -z "$DESCRIPTION" ]; then
    echo -e "${RED}❌ 커밋 설명이 비어있습니다${NC}"
    exit 1
fi

# 설명 첫 글자 대문자 확인 (한글 제외)
if echo "$DESCRIPTION" | grep -qE "^[a-z]"; then
    echo -e "${YELLOW}⚠️ 설명의 첫 글자는 대문자로 시작하는 것이 좋습니다${NC}"
    echo -e "${YELLOW}💡 현재: '$DESCRIPTION'${NC}"
fi

# 설명 마지막 마침표 확인
if echo "$DESCRIPTION" | grep -q "\.$"; then
    echo -e "${YELLOW}⚠️ 설명 끝에 마침표(.)를 사용하지 않는 것이 좋습니다${NC}"
fi

# ===== 금지된 단어 확인 =====
FORBIDDEN_WORDS="TODO|FIXME|XXX|HACK|TEMP"
if echo "$COMMIT_MSG" | grep -qiE "$FORBIDDEN_WORDS"; then
    echo -e "${RED}❌ 커밋 메시지에 금지된 단어가 포함되어 있습니다${NC}"
    echo -e "${YELLOW}💡 금지된 단어: $FORBIDDEN_WORDS${NC}"
    exit 1
fi

# ===== Breaking Changes 확인 =====
if echo "$COMMIT_MSG" | grep -q "BREAKING CHANGE"; then
    echo -e "${YELLOW}⚠️ Breaking Change가 감지되었습니다${NC}"
    echo -e "${YELLOW}💡 버전 업데이트를 고려하세요${NC}"
fi

# ===== 커밋 통계 =====
echo -e "\n${BLUE}📊 커밋 통계:${NC}"
echo -e "${BLUE}  • 타입: $TYPE${NC}"
if [ -n "$SCOPE" ]; then
    echo -e "${BLUE}  • 스코프: $SCOPE${NC}"
fi
echo -e "${BLUE}  • 설명: $DESCRIPTION${NC}"
echo -e "${BLUE}  • 길이: $MSG_LENGTH/$MAX_LENGTH 자${NC}"

# ===== 성공 메시지 =====
echo -e "\n${GREEN}✅ 커밋 메시지가 Conventional Commits 표준을 준수합니다${NC}"
echo -e "${GREEN}🎉 커밋을 진행합니다!${NC}"

exit 0