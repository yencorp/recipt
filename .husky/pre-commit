#!/usr/bin/env sh

# =================================================================
# Pre-commit Git Hook
# 프로젝트: 광남동성당 청소년위원회 예결산 관리 시스템
# 설명: 커밋 전 코드 품질 검사 및 포맷팅
# =================================================================

. "$(dirname -- "$0")/_/husky.sh"

# 색상 정의
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

echo -e "${BLUE}🔍 Pre-commit 검사를 시작합니다...${NC}"

# 변경된 파일 확인
CHANGED_FILES=$(git diff --cached --name-only --diff-filter=ACM)

if [ -z "$CHANGED_FILES" ]; then
    echo -e "${YELLOW}⚠️ 변경된 파일이 없습니다.${NC}"
    exit 0
fi

echo -e "${BLUE}📋 변경된 파일:${NC}"
echo "$CHANGED_FILES" | sed 's/^/  • /'

# 에러 카운터
ERROR_COUNT=0

# ===== JavaScript/TypeScript 파일 검사 =====
JS_TS_FILES=$(echo "$CHANGED_FILES" | grep -E '\.(js|ts|jsx|tsx)$' || true)
if [ -n "$JS_TS_FILES" ]; then
    echo -e "\n${BLUE}🔧 JavaScript/TypeScript 파일 검사 중...${NC}"
    
    # ESLint 검사
    if command -v npx >/dev/null 2>&1; then
        echo -e "${BLUE}• ESLint 검사...${NC}"
        if ! echo "$JS_TS_FILES" | xargs npx eslint --fix; then
            echo -e "${RED}❌ ESLint 검사 실패${NC}"
            ERROR_COUNT=$((ERROR_COUNT + 1))
        else
            echo -e "${GREEN}✅ ESLint 검사 통과${NC}"
        fi
        
        # Prettier 포맷팅
        echo -e "${BLUE}• Prettier 포맷팅...${NC}"
        if ! echo "$JS_TS_FILES" | xargs npx prettier --write; then
            echo -e "${RED}❌ Prettier 포맷팅 실패${NC}"
            ERROR_COUNT=$((ERROR_COUNT + 1))
        else
            echo -e "${GREEN}✅ Prettier 포맷팅 완료${NC}"
        fi
        
        # TypeScript 타입 체크 (TypeScript 파일이 있는 경우)
        TS_FILES=$(echo "$JS_TS_FILES" | grep -E '\.(ts|tsx)$' || true)
        if [ -n "$TS_FILES" ]; then
            echo -e "${BLUE}• TypeScript 타입 체크...${NC}"
            if ! npx tsc --noEmit --skipLibCheck; then
                echo -e "${RED}❌ TypeScript 타입 체크 실패${NC}"
                ERROR_COUNT=$((ERROR_COUNT + 1))
            else
                echo -e "${GREEN}✅ TypeScript 타입 체크 통과${NC}"
            fi
        fi
    fi
fi

# ===== Python 파일 검사 =====
PY_FILES=$(echo "$CHANGED_FILES" | grep -E '\.py$' || true)
if [ -n "$PY_FILES" ]; then
    echo -e "\n${BLUE}🐍 Python 파일 검사 중...${NC}"
    
    # Black 포맷팅 (Docker 컨테이너에서 실행)
    if command -v docker >/dev/null 2>&1; then
        echo -e "${BLUE}• Black 포맷팅...${NC}"
        if ! docker-compose -f docker-compose.dev.yml exec -T ocr-service black --check .; then
            echo -e "${YELLOW}⚡ Black으로 포맷팅을 적용합니다...${NC}"
            docker-compose -f docker-compose.dev.yml exec -T ocr-service black .
        fi
        echo -e "${GREEN}✅ Black 포맷팅 완료${NC}"
        
        # Flake8 린트 검사
        echo -e "${BLUE}• Flake8 린트 검사...${NC}"
        if ! docker-compose -f docker-compose.dev.yml exec -T ocr-service flake8 --max-line-length=88 --extend-ignore=E203,W503 .; then
            echo -e "${RED}❌ Flake8 린트 검사 실패${NC}"
            ERROR_COUNT=$((ERROR_COUNT + 1))
        else
            echo -e "${GREEN}✅ Flake8 린트 검사 통과${NC}"
        fi
        
        # isort import 정렬
        echo -e "${BLUE}• isort import 정렬...${NC}"
        docker-compose -f docker-compose.dev.yml exec -T ocr-service isort --check-only --diff . || {
            echo -e "${YELLOW}⚡ import를 정렬합니다...${NC}"
            docker-compose -f docker-compose.dev.yml exec -T ocr-service isort .
        }
        echo -e "${GREEN}✅ import 정렬 완료${NC}"
    fi
fi

# ===== JSON/YAML 파일 검사 =====
CONFIG_FILES=$(echo "$CHANGED_FILES" | grep -E '\.(json|yaml|yml)$' || true)
if [ -n "$CONFIG_FILES" ]; then
    echo -e "\n${BLUE}⚙️ 설정 파일 검사 중...${NC}"
    
    # JSON 파일 유효성 검사
    JSON_FILES=$(echo "$CONFIG_FILES" | grep -E '\.json$' || true)
    if [ -n "$JSON_FILES" ]; then
        echo -e "${BLUE}• JSON 파일 유효성 검사...${NC}"
        for file in $JSON_FILES; do
            if ! python3 -m json.tool "$file" > /dev/null; then
                echo -e "${RED}❌ JSON 파일 오류: $file${NC}"
                ERROR_COUNT=$((ERROR_COUNT + 1))
            fi
        done
        echo -e "${GREEN}✅ JSON 파일 검사 통과${NC}"
    fi
    
    # YAML 파일 유효성 검사
    YAML_FILES=$(echo "$CONFIG_FILES" | grep -E '\.(yaml|yml)$' || true)
    if [ -n "$YAML_FILES" ] && command -v python3 >/dev/null 2>&1; then
        echo -e "${BLUE}• YAML 파일 유효성 검사...${NC}"
        for file in $YAML_FILES; do
            if ! python3 -c "import yaml; yaml.safe_load(open('$file'))" 2>/dev/null; then
                echo -e "${RED}❌ YAML 파일 오류: $file${NC}"
                ERROR_COUNT=$((ERROR_COUNT + 1))
            fi
        done
        echo -e "${GREEN}✅ YAML 파일 검사 통과${NC}"
    fi
fi

# ===== 보안 검사 =====
echo -e "\n${BLUE}🔒 보안 검사 중...${NC}"

# 민감 정보 패턴 검사
SENSITIVE_PATTERNS=(
    "password.*=.*['\"][^'\"]*['\"]"
    "api.*key.*=.*['\"][^'\"]*['\"]"
    "secret.*=.*['\"][^'\"]*['\"]"
    "token.*=.*['\"][^'\"]*['\"]"
    "aws.*access.*key"
    "private.*key"
)

for pattern in "${SENSITIVE_PATTERNS[@]}"; do
    if echo "$CHANGED_FILES" | xargs grep -il "$pattern" 2>/dev/null; then
        echo -e "${RED}❌ 민감한 정보가 포함되어 있을 수 있습니다: $pattern${NC}"
        ERROR_COUNT=$((ERROR_COUNT + 1))
    fi
done

if [ $ERROR_COUNT -eq 0 ]; then
    echo -e "${GREEN}✅ 보안 검사 통과${NC}"
fi

# ===== 파일 크기 검사 =====
echo -e "\n${BLUE}📏 파일 크기 검사 중...${NC}"
LARGE_FILES=$(echo "$CHANGED_FILES" | xargs ls -la 2>/dev/null | awk '$5 > 1048576 {print $9, "(" $5 " bytes)"}' || true)
if [ -n "$LARGE_FILES" ]; then
    echo -e "${YELLOW}⚠️ 큰 파일이 감지되었습니다 (1MB 초과):${NC}"
    echo "$LARGE_FILES" | sed 's/^/  • /'
    ERROR_COUNT=$((ERROR_COUNT + 1))
fi

# ===== 변경된 파일 다시 스테이징 =====
if [ $ERROR_COUNT -eq 0 ]; then
    echo -e "\n${BLUE}📦 수정된 파일을 다시 스테이징합니다...${NC}"
    echo "$CHANGED_FILES" | xargs git add
fi

# ===== 결과 출력 =====
echo -e "\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
if [ $ERROR_COUNT -eq 0 ]; then
    echo -e "${GREEN}🎉 Pre-commit 검사 통과! 커밋을 진행합니다.${NC}"
    exit 0
else
    echo -e "${RED}❌ $ERROR_COUNT 개의 오류가 발견되었습니다.${NC}"
    echo -e "${YELLOW}💡 오류를 수정한 후 다시 커밋하세요.${NC}"
    exit 1
fi