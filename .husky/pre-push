#!/usr/bin/env sh

# =================================================================
# Pre-push Git Hook
# 프로젝트: 광남동성당 청소년위원회 예결산 관리 시스템
# 설명: 푸시 전 테스트 실행 및 빌드 검증
# =================================================================

. "$(dirname -- "$0")/_/husky.sh"

# 색상 정의
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

echo -e "${BLUE}🚀 Pre-push 검사를 시작합니다...${NC}"

# 현재 브랜치 확인
CURRENT_BRANCH=$(git rev-parse --abbrev-ref HEAD)
echo -e "${BLUE}📋 현재 브랜치: $CURRENT_BRANCH${NC}"

# 에러 카운터
ERROR_COUNT=0

# 푸시하려는 브랜치 정보 읽기
while read local_ref local_sha remote_ref remote_sha; do
    # 브랜치 삭제인 경우 건너뛰기
    if [ "$local_sha" = "0000000000000000000000000000000000000000" ]; then
        continue
    fi
    
    echo -e "${BLUE}🔍 브랜치 $local_ref 검사 중...${NC}"
    
    # main/master 브랜치 보호
    branch_name=$(echo "$remote_ref" | sed 's/refs\/heads\///')
    if [ "$branch_name" = "main" ] || [ "$branch_name" = "master" ]; then
        echo -e "\n${YELLOW}⚠️ $branch_name 브랜치로 직접 푸시하는 것은 권장되지 않습니다.${NC}"
        echo -e "${YELLOW}💡 PR(Pull Request)을 통한 머지를 권장합니다.${NC}"
        read -p "계속 진행하시겠습니까? (y/N): " -n 1 -r
        echo
        if [[ ! $REPLY =~ ^[Yy]$ ]]; then
            echo -e "${RED}❌ Push가 취소되었습니다.${NC}"
            exit 1
        fi
    fi
    
    # develop 브랜치 추가 검사
    if [ "$branch_name" = "develop" ]; then
        echo -e "${BLUE}🧪 Develop 브랜치 추가 검사 실행...${NC}"
    fi
done

# ===== Docker 컨테이너 상태 확인 =====
echo -e "\n${BLUE}🐳 Docker 컨테이너 상태 확인...${NC}"
if ! docker-compose -f docker-compose.dev.yml ps | grep -q "Up"; then
    echo -e "${RED}❌ Docker 컨테이너가 실행되지 않았습니다.${NC}"
    echo -e "${YELLOW}💡 개발환경을 시작하세요: ./scripts/dev-start.sh${NC}"
    ERROR_COUNT=$((ERROR_COUNT + 1))
else
    echo -e "${GREEN}✅ Docker 컨테이너 실행 중${NC}"
fi

# ===== 단위 테스트 실행 =====
echo -e "\n${BLUE}🧪 단위 테스트 실행...${NC}"

# 백엔드 테스트
if [ -f "apps/backend/package.json" ]; then
    echo -e "${BLUE}• 백엔드 테스트 실행...${NC}"
    if docker-compose -f docker-compose.dev.yml exec -T backend npm test --passWithNoTests 2>/dev/null; then
        echo -e "${GREEN}✅ 백엔드 테스트 통과${NC}"
    else
        echo -e "${YELLOW}⚠️ 백엔드 테스트를 건너뜁니다 (컨테이너 미실행 또는 테스트 없음)${NC}"
    fi
fi

# 프론트엔드 테스트
if [ -f "apps/frontend/package.json" ]; then
    echo -e "${BLUE}• 프론트엔드 테스트 실행...${NC}"
    if docker-compose -f docker-compose.dev.yml exec -T frontend npm test --passWithNoTests 2>/dev/null; then
        echo -e "${GREEN}✅ 프론트엔드 테스트 통과${NC}"
    else
        echo -e "${YELLOW}⚠️ 프론트엔드 테스트를 건너뜁니다 (컨테이너 미실행 또는 테스트 없음)${NC}"
    fi
fi

# OCR 서비스 테스트
if [ -f "apps/ocr-service/requirements.txt" ]; then
    echo -e "${BLUE}• OCR 서비스 테스트 실행...${NC}"
    if docker-compose -f docker-compose.dev.yml exec -T ocr-service python -m pytest --tb=short -q 2>/dev/null; then
        echo -e "${GREEN}✅ OCR 서비스 테스트 통과${NC}"
    else
        echo -e "${YELLOW}⚠️ OCR 서비스 테스트를 건너뜁니다 (컨테이너 미실행 또는 테스트 없음)${NC}"
    fi
fi

# ===== 빌드 검증 =====
echo -e "\n${BLUE}🏗️ 빌드 검증...${NC}"

# 백엔드 빌드
if [ -f "apps/backend/tsconfig.json" ]; then
    echo -e "${BLUE}• 백엔드 TypeScript 빌드...${NC}"
    if docker-compose -f docker-compose.dev.yml exec -T backend npm run build 2>/dev/null; then
        echo -e "${GREEN}✅ 백엔드 빌드 성공${NC}"
    else
        echo -e "${RED}❌ 백엔드 빌드 실패${NC}"
        ERROR_COUNT=$((ERROR_COUNT + 1))
    fi
fi

# 프론트엔드 빌드
if [ -f "apps/frontend/vite.config.ts" ] || [ -f "apps/frontend/vite.config.js" ]; then
    echo -e "${BLUE}• 프론트엔드 VITE 빌드...${NC}"
    if docker-compose -f docker-compose.dev.yml exec -T frontend npm run build 2>/dev/null; then
        echo -e "${GREEN}✅ 프론트엔드 빌드 성공${NC}"
    else
        echo -e "${RED}❌ 프론트엔드 빌드 실패${NC}"
        ERROR_COUNT=$((ERROR_COUNT + 1))
    fi
fi

# ===== 보안 취약점 검사 =====
echo -e "\n${BLUE}🔒 보안 취약점 검사...${NC}"

# npm audit (백엔드)
if [ -f "apps/backend/package.json" ]; then
    echo -e "${BLUE}• 백엔드 보안 취약점 검사...${NC}"
    if docker-compose -f docker-compose.dev.yml exec -T backend npm audit --audit-level=high 2>/dev/null; then
        echo -e "${GREEN}✅ 백엔드 보안 취약점 없음${NC}"
    else
        echo -e "${YELLOW}⚠️ 백엔드에서 보안 취약점이 발견되었습니다${NC}"
    fi
fi

# npm audit (프론트엔드)
if [ -f "apps/frontend/package.json" ]; then
    echo -e "${BLUE}• 프론트엔드 보안 취약점 검사...${NC}"
    if docker-compose -f docker-compose.dev.yml exec -T frontend npm audit --audit-level=high 2>/dev/null; then
        echo -e "${GREEN}✅ 프론트엔드 보안 취약점 없음${NC}"
    else
        echo -e "${YELLOW}⚠️ 프론트엔드에서 보안 취약점이 발견되었습니다${NC}"
    fi
fi

# Safety 검사 (Python)
if [ -f "apps/ocr-service/requirements.txt" ]; then
    echo -e "${BLUE}• OCR 서비스 보안 취약점 검사...${NC}"
    if docker-compose -f docker-compose.dev.yml exec -T ocr-service safety check 2>/dev/null; then
        echo -e "${GREEN}✅ OCR 서비스 보안 취약점 없음${NC}"
    else
        echo -e "${YELLOW}⚠️ OCR 서비스에서 보안 취약점이 발견되었거나 safety 도구가 없습니다${NC}"
    fi
fi

# ===== API 헬스체크 =====
echo -e "\n${BLUE}🏥 API 헬스체크...${NC}"

# 백엔드 API
if curl -s -f http://localhost:8000/api/health >/dev/null 2>&1; then
    echo -e "${GREEN}✅ 백엔드 API 정상 동작${NC}"
else
    echo -e "${YELLOW}⚠️ 백엔드 API 응답 없음 (컨테이너 미실행일 수 있음)${NC}"
fi

# OCR 서비스 API
if curl -s -f http://localhost:8001/health >/dev/null 2>&1; then
    echo -e "${GREEN}✅ OCR 서비스 API 정상 동작${NC}"
else
    echo -e "${YELLOW}⚠️ OCR 서비스 API 응답 없음 (컨테이너 미실행일 수 있음)${NC}"
fi

# 프론트엔드 서비스
if curl -s -f http://localhost:3000 >/dev/null 2>&1; then
    echo -e "${GREEN}✅ 프론트엔드 서비스 정상 동작${NC}"
else
    echo -e "${YELLOW}⚠️ 프론트엔드 서비스 응답 없음 (컨테이너 미실행일 수 있음)${NC}"
fi

# ===== 커밋 메시지 검증 (최근 커밋들) =====
echo -e "\n${BLUE}📝 최근 커밋 메시지 검증...${NC}"
RECENT_COMMITS=$(git log --oneline -5 --format="%s")
echo -e "${BLUE}최근 5개 커밋:${NC}"
echo "$RECENT_COMMITS" | sed 's/^/  • /'

# ===== 결과 출력 =====
echo -e "\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"

if [ $ERROR_COUNT -eq 0 ]; then
    echo -e "${GREEN}🎉 Pre-push 검사 통과! Push를 진행합니다.${NC}"
    echo -e "${BLUE}📤 Push 대상 브랜치: $CURRENT_BRANCH${NC}"
    exit 0
else
    echo -e "${RED}❌ $ERROR_COUNT 개의 오류가 발견되었습니다.${NC}"
    echo -e "${YELLOW}💡 오류를 수정한 후 다시 푸시하세요.${NC}"
    echo -e "${YELLOW}🆘 긴급한 경우 --no-verify 옵션을 사용할 수 있습니다.${NC}"
    exit 1
fi